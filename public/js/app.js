function getQueryVariable(e){for(var t=window.location.search.substring(1),s=t.split("&"),i=0;i<s.length;i++){var n=s[i].split("=");if(decodeURIComponent(n[0])===e)return decodeURIComponent(n[1])}}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function setAuthCookie(e,t){var s=window.location,i=new Date;i.setTime(i.getTime()+6048e5);var n="expires="+i.toUTCString(),o="session="+e+":"+t+";"+n+";path=/;";"https:"===s.protocol&&(o+="secure;"),document.cookie=o}function getAuthCookie(){for(var e=document.cookie.split(";"),t=0;t<e.length;t++){for(var s=e[t];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf("session=")){var i=s.substring("session=".length,s.length).split(":");return{session_key:i[0],username:i[1]}}}return null}function deleteAuthCookie(){var e=new Date;e.setDate(e.getDate()-1);var t="expires="+e;document.cookie="session=;"+t+"; path=/"}window.App={elements:{board:$("#board"),palette:$(".palette"),boardMover:$(".board-mover"),boardZoomer:$(".board-zoomer"),boardContainer:$(".board-container"),cursor:$(".cursor"),timer:$(".cooldown-timer"),reticule:$(".reticule"),alert:$(".message"),coords:$(".coords"),chatContainer:$(".chat-container"),usersContainer:$(".users-container"),loginContainer:$(".login-container"),usersToggle:$(".toggle-users"),chatToggle:$(".toggle-chat"),usersToggle:$(".toggle-users"),loginToggle:$(".toggle-login"),loginButton:$(".login-button"),chatInput:$(".chat-input"),restrictedToggle:$(".restricted-toggle")},panX:0,panY:0,scale:4,cooldown:0,init:function(){this.color=-1,this.connectionLost=!1,this.mod_tools_requested=!1,this.showRestrictedAreas=!1,this.restrictedAreas=null,this.username=null,this.session_id=null,this.session_key=null,this.spectate_user=null,$(".board-container").hide(),$(".reticule").hide(),$(".ui").hide(),$(".message").hide(),$(".cursor").hide(),$(".cooldown-timer").hide(),this.elements.usersToggle.hide(),$.get("/boardinfo",this.initBoard.bind(this)),this.initBoardMovement(),this.initBoardPlacement(),this.initCursor(),this.initReticule(),this.initAlert(),this.initCoords(),this.initSidebar(),this.initMoveTicker(),this.initRestrictedAreas(),this.initContextMenu(),Notification.requestPermission()},initBoard:function(e){this.width=e.width,this.height=e.height,this.palette=e.palette,this.initPalette(),this.elements.board.attr("width",this.width).attr("height",this.height),this.updateTransform();var t=getQueryVariable("x")||this.width/2,s=getQueryVariable("y")||this.height/2;(t<0||t>=this.width)&&(t=this.width/2),(s<0||s>=this.height)&&(t=this.height/2),this.centerOn(t,s),this.scale=getQueryVariable("scale")||this.scale,this.updateTransform(),this.initSocket(),this.drawBoard()},drawBoard:function(){this.image=new Image,this.image.onload=function(){this.elements.board[0].getContext("2d").drawImage(this.image,0,0,this.width,this.height)}.bind(this),this.image.onerror=function(){$(".loading").fadeIn(500),$(".loading").children()[0].text("Failed to load image, please refresh")},this.image.src="/boarddata?d="+Date.now()},initRestrictedAreas:function(){this.elements.restrictedToggle.click(this.restrictedAreaToggle.bind(this))},restrictedAreaToggle:function(){this.loadRestrictedAreas(),this.showRestrictedAreas=!this.showRestrictedAreas,this.showRestrictedAreas?this.elements.restrictedToggle.text("Hide Restricted Areas"):this.elements.restrictedToggle.text("Show Restricted Areas")},loadRestrictedAreas:function(){null===this.restrictedAreas&&$.get("/restricted",function(e){this.restrictedAreas=[],e.forEach(function(e){e.div=$("<div>",{class:"selection"}),$(".ui").append(e.div),this.restrictedAreas.push(e)}.bind(this))}.bind(this)),this.elements.board.on("mousemove",function(e){null!==this.restrictedAreas&&this.restrictedAreas.forEach(function(e){if(this.showRestrictedAreas){var t=(e.end.x-(e.start.x-1))*App.scale,s=(e.end.y-(e.start.y-1))*App.scale,i=App.boardToScreenSpace(e.start.x,e.start.y);e.div.css("transform","translate("+i.x+"px, "+i.y+"px)"),e.div.css("width",t+"px").css("height",s+"px"),e.div.show()}else e.div.hide()}.bind(this))}.bind(this))},initPalette:function(){this.palette.forEach(function(e,t){$("<div>").addClass("palette-color").css("background-color",e).click(function(){0===this.cooldown?this.switchColor(t):this.switchColor(-1)}.bind(this)).appendTo(this.elements.palette)}.bind(this))},initBoardMovement:function(){var e=function(e){this.panX+=e.dx/this.scale,this.panY+=e.dy/this.scale,this.updateTransform()}.bind(this);interact(this.elements.boardContainer[0]).draggable({inertia:!1,onmove:e}).gesturable({onmove:function(t){this.scale*=1+t.ds,this.updateTransform(),e(t)}.bind(this)}).styleCursor(!1),$(document).on("keydown",function(e){"BODY"===e.target.nodeName&&(87===e.keyCode||38===e.keyCode?this.panY=e.shiftKey?this.panY+=1:this.panY+=100/this.scale:83===e.keyCode||40===e.keyCode?this.panY=e.shiftKey?this.panY-=1:this.panY-=100/this.scale:65===e.keyCode||37===e.keyCode?this.panX=e.shiftKey?this.panX+=1:this.panX+=100/this.scale:68===e.keyCode||39===e.keyCode?this.panX=e.shiftKey?this.panX-=1:this.panX-=100/this.scale:81===e.keyCode||34===e.keyCode?(this.scale/=1.3,this.scale=Math.min(this.maxScale,Math.max(this.minScale,this.scale))):69===e.keyCode||33===e.keyCode?(this.scale*=1.3,this.scale=Math.min(this.maxScale,Math.max(this.minScale,this.scale))):27===e.keyCode&&this.switchColor(-1),this.updateTransform())}.bind(this)),this.elements.boardContainer.on("wheel",function(e){var t=this.scale;e.originalEvent.deltaY>0?this.scale/=1.3:this.scale*=1.3,this.scale=Math.min(40,Math.max(.75,this.scale));var s=e.clientX-this.elements.boardContainer.width()/2,i=e.clientY-this.elements.boardContainer.height()/2;this.panX-=s/t,this.panX+=s/this.scale,this.panY-=i/t,this.panY+=i/this.scale,this.updateTransform()}.bind(this))},initBoardPlacement:function(){var e,t,s=!1,i=function(i){e=i.clientX,t=i.clientY,s=!1},n=function(i){null!==this.spectate_user&&(this.spectate_user=null,this.alert(null));var n=Math.abs(e-i.clientX),o=Math.abs(t-i.clientY);if(n<5&&o<5&&-1!==this.color&&this.cooldown<=0&&1===i.which&&!s){s=!0;var a=this.screenToBoardSpace(i.clientX,i.clientY);this.place(a.x,a.y)}}.bind(this);this.elements.board.on("pointerdown",i).on("mousedown",i).on("pointerup",n).on("mouseup",n).contextmenu(function(e){e.preventDefault(),this.switchColor(-1)}.bind(this))},initCursor:function(){var e=function(e){this.elements.cursor.css("transform","translate("+e.clientX+"px, "+e.clientY+"px)")}.bind(this);this.elements.boardContainer.on("pointermove",e).on("mousemove",e)},initReticule:function(){var e=function(e){var t=this.screenToBoardSpace(e.clientX,e.clientY);t.x|=0,t.y|=0;var s=this.boardToScreenSpace(t.x,t.y);this.elements.reticule.css("transform","translate("+s.x+"px, "+s.y+"px)"),this.elements.reticule.css("width",this.scale-1+"px").css("height",this.scale-1+"px"),-1===this.color?this.elements.reticule.hide():this.elements.reticule.show()}.bind(this);this.elements.board.on("pointermove",e).on("mousemove",e)},initCoords:function(){this.elements.board.on("mousemove",function(e){var t=this.screenToBoardSpace(e.clientX,e.clientY);this.elements.coords.text("("+t.x+", "+t.y+")")}.bind(this))},initAlert:function(){this.elements.alert.find(".close").click(function(){this.elements.alert.fadeOut(200)}.bind(this))},initSocket:function(){var e=0;this.socket=io(),this.socket.on("connect",function(){$(".board-container").show(),$(".ui").show(),$(".loading").fadeOut(500),this.elements.alert.fadeOut(200);var e=getAuthCookie();null!==e&&(this.username=e.username,this.session_key=e.session_key,this.socket.emit("reauth",{username:this.username,session_key:this.session_key})),this.connectionLost&&this.drawBoard()}.bind(this)),this.socket.on("disconnect",function(){this.connectionLost=!0,this.alert("Disconnected from server... Attempting to reconnect")}.bind(this));var t=$(".move-ticker-body");this.socket.on("session",function(e){this.session_id=e.session_id,this.updateUserCount(e.users.connected),this.updateUserList(e.users)}.bind(this)),this.socket.on("place",function(e){var s=this.elements.board[0].getContext("2d");if(s.fillStyle=e.color,s.fillRect(e.x,e.y,1,1),t.is(":visible")){var i=$("<div>",{class:"chat-line"}).appendTo(t);$("<span>",{class:"username"}).text(e.session_id).appendTo(i),$("<a>",{href:"javascript:App.centerOn("+e.x+","+e.y+")"}).text(": "+e.x+", "+e.y).appendTo(i),t.scrollTop(t.prop("scrollHeight")),t.children().length>=15&&t.children().first().remove()}null!==this.spectate_user&&this.spectate_user===e.session_id&&this.centerOn(e.x,e.y)}.bind(this)),this.socket.on("alert",function(e){this.alert(e)}.bind(this)),this.socket.on("cooldown",function(e){this.cooldown=Math.ceil(e+1),this.updateTime()}.bind(this)),this.socket.on("force-sync",function(){this.drawBoard()}.bind(this)),this.socket.on("auth",function(e){e.message&&this.alert(e.message),this.onAuthentication(e,!1)}.bind(this)),this.socket.on("reauth",function(e){e.message&&this.alert(e.message),this.onAuthentication(e,!0)}.bind(this)),this.socket.on("users",function(e){this.updateUserCount(e.connected),this.updateUserList(e)}.bind(this)),this.socket.on("chat",function(t){var s=$(".chat-log"),i=$("<div>",{class:"chat-line"}).appendTo(s),n=$("<span>",{class:"username"}).text(t.chat_id),o=$("<span>",{class:"chat-message"}).text(": "+t.message);this.elements.chatContainer.is(":hidden")&&e<=125?(e++,this.elements.chatToggle.text("Chat ("+e+")")):e=0;var a,h,r=!1,l=[],h=/(@[a-z0-9]+)/gi;do{if(a=h.exec(o.html())){var c=a[0].replace("@","").toLowerCase();r||t.chat_id===this.username||c!==this.username&&"everyone"!==c&&"world"!==c||(r=!0,new Notification("Place Reloaded",{body:"Message from "+t.chat_id+": "+t.message}));var d=$("<span>",{class:"username"}).text(a[0]).prop("outerHTML");l.push({div:d,index:a.index,length:a[0].length})}}while(a);for(var u=l.length-1;u>=0;u--)o.html(o.html().substr(0,l[u].index)+l[u].div+o.html().substr(l[u].index+l[u].length,o.html().length));l=[],h=/([0-9]+)+\,(\ +)?([0-9]+)/g;do{if(a=h.exec(o.html())){var m=a[0].split(",");if(m[0]<0||m[0]>this.width||m[1]<0||m[1]>this.height)continue;var p=$("<a>",{class:"",href:"javascript:App.centerOn("+m[0]+","+m[1]+")"}).text(a[0]).prop("outerHTML");l.push({div:p,index:a.index,length:a[0].length})}}while(a);for(var u=l.length-1;u>=0;u--)o.html(o.html().substr(0,l[u].index)+l[u].div+o.html().substr(l[u].index+l[u].length,o.html().length));t.is_moderator&&n.addClass("moderator"),n.appendTo(i),o.appendTo(i),s.scrollTop(s.prop("scrollHeight")),s.children().length>=125&&s.find(".chat-line:first").remove()}.bind(this))},updateUserList:function(e){var t=$(".moderators"),s=t.closest(".user-list-section");0!==e.moderators.length?(t.empty(),s.show(),e.moderators.forEach(function(e){$("<div>",{class:"username moderator"}).text(e).appendTo(t)})):s.hide(),t=$(".registered"),s=t.closest(".user-list-section"),0!==e.registered.length?(t.empty(),s.show(),e.registered.forEach(function(e){$("<div>",{class:"username"}).text(e).appendTo(t)})):s.hide(),t=$(".anons"),s=t.closest(".user-list-section"),0!==e.anons.length?(t.empty(),s.show(),e.anons.forEach(function(e){$("<div>",{class:"username"}).text(e).appendTo(t)})):s.hide()},initContextMenu:function(){["right","left"].forEach(function(e){$.contextMenu({selector:".username",trigger:e,zIndex:1e3,autoHide:!0,items:{spectate:{name:"Spectate",callback:function(e,t){App.spectate(t.$trigger.text())}},mention:{name:"Mention",callback:function(e,t){App.mention(t.$trigger.text())}}}})})},updateUserCount:function(e){this.elements.usersToggle.fadeIn(200),this.elements.usersToggle.text("Users: "+e)},authenticateChat:function(){this.username=$("#username").val(),this.socket.emit("auth",{username:this.username,password:$("#password").val()})},onAuthentication:function(data,reauth){data.success?(this.session_key=data.session_key,this.elements.loginToggle.text("Logout"),this.elements.loginContainer.hide(),this.elements.palette.removeClass("palette-sidebar"),reauth||setAuthCookie(data.session_key,this.username),data.is_moderator&&!this.mod_tools_requested&&(this.mod_tools_requested=!0,$.get("js/mod_tools.js",function(data){eval(data)}))):(this.session_key=null,this.username=null,deleteAuthCookie(),reauth&&location.reload(),this.elements.loginToggle.text("Login"),this.elements.loginButton.prop("disabled",!1))},initSidebar:function(){this.elements.chatToggle.click(function(){this.elements.chatContainer.toggle(),this.elements.usersContainer.hide(),this.elements.loginContainer.hide(),this.elements.chatToggle.text("Chat"),this.elements.chatContainer.is(":visible")?(this.elements.palette.addClass("palette-sidebar"),this.elements.chatInput.focus()):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.usersToggle.click(function(){this.elements.chatContainer.hide(),this.elements.usersContainer.toggle(),this.elements.loginContainer.hide(),this.elements.usersContainer.is(":visible")?this.elements.palette.addClass("palette-sidebar"):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.loginToggle.click(function(){if(null!==this.session_key)return this.socket.emit("logout",{type:"logout",session_key:this.session_key}),this.session_key=null,this.username=null,deleteAuthCookie(),location.reload(),this.elements.loginToggle.text("Login"),void this.elements.loginButton.prop("disabled",!1);this.elements.chatContainer.hide(),this.elements.usersContainer.hide(),this.elements.loginContainer.toggle(),this.elements.loginContainer.is(":visible")?(this.elements.palette.addClass("palette-sidebar"),$("#username").focus()):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.loginButton.click(function(){this.elements.loginButton.prop("disabled",!0),this.authenticateChat()}.bind(this)),this.elements.chatInput.keypress(function(e){if(13==e.which){e.preventDefault();var t=this.elements.chatInput.val();if(""===t)return;this.socket.emit("chat",t),this.elements.chatInput.val("")}}.bind(this))},initMoveTicker:function(){var e=$(".user-list"),t=$(".move-ticker-header"),s=$(".move-ticker-body");t.click(function(){s.toggle(),s.scrollTop(s.prop("scrollHeight")),s.is(":visible")?e.addClass("user-list-ticker"):e.removeClass("user-list-ticker")})},updateTransform:function(){this.panX<=-this.width/2&&(this.panX=-this.width/2),this.panX>=this.width/2&&(this.panX=this.width/2),this.panY<=-this.height/2&&(this.panY=-this.height/2),this.panY>=this.height/2&&(this.panY=this.height/2),this.elements.boardMover.css("width",this.width+"px").css("height",this.height+"px").css("transform","translate("+this.panX+"px, "+this.panY+"px)"),this.elements.reticule.css("width",this.scale+"px").css("height",this.scale+"px"),this.elements.boardZoomer.css("transform","scale("+this.scale+")")},screenToBoardSpace:function(e,t){var s=this.elements.board[0].getBoundingClientRect();return{x:(e-s.left)/this.scale|0,y:(t-s.top)/this.scale|0}},boardToScreenSpace:function(e,t){var s=this.elements.board[0].getBoundingClientRect();return{x:e*this.scale+s.left,y:t*this.scale+s.top}},centerOn:function(e,t){this.panX=this.width/2-e-.5,this.panY=this.height/2-t-.5,this.elements.coords.text("("+e+", "+t+")"),this.updateTransform()},switchColor:function(e){this.color=e,-1===e?this.elements.cursor.hide():(this.elements.cursor.show(),this.elements.cursor.css("background-color",this.palette[e]))},place:function(e,t){-1!==this.color&&this.socket.emit("place",{x:e,y:t,color:this.palette[this.color]})},alert:function(e){var t=this.elements.alert;if(null===e)return void this.elements.alert.fadeOut(200);t.find(".text").text(e),t.fadeIn(200)},updateTime:function(){var e=this.cooldown;if(this.cooldown-=1,this.cooldown<0&&(this.cooldown=0),this.cooldown|=0,0!==this.cooldown){this.elements.timer.show();var t=Math.floor(this.cooldown%60),s=t<10?"0"+t:t,i=Math.floor(this.cooldown/60),n=i<10?"0"+i:i;this.elements.timer.text(n+":"+s),$(".palette-color").css("cursor","not-allowed")}else this.elements.timer.hide(),$(".palette-color").css("cursor","");0===this.cooldown&&0!==e||setTimeout(this.updateTime.bind(this),1e3)},spectate:function(e){e.startsWith("@")&&(e=e.substr(1)),this.alert("Spectating "+e),this.spectate_user=e},mention:function(e){this.elements.usersContainer.hide(),this.elements.chatContainer.show(),e.startsWith("@")||(e="@"+e),this.elements.chatInput.val(this.elements.chatInput.val()+e+" "),this.elements.chatInput.focus()},toURL:function(){window.open(this.elements.board[0].toDataURL(),"_blank")}},App.init();