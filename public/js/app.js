function getQueryVariable(e){for(var t=window.location.search.substring(1),s=t.split("&"),i=0;i<s.length;i++){var n=s[i].split("=");if(decodeURIComponent(n[0])===e)return decodeURIComponent(n[1])}}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}window.App={elements:{board:$("#board"),palette:$(".palette"),boardMover:$(".board-mover"),boardZoomer:$(".board-zoomer"),boardContainer:$(".board-container"),cursor:$(".cursor"),timer:$(".cooldown-timer"),reticule:$(".reticule"),alert:$(".message"),coords:$(".coords"),chatContainer:$(".chat-container"),usersContainer:$(".users-container"),loginContainer:$(".login-container"),usersToggle:$(".toggle-users"),chatToggle:$(".toggle-chat"),usersToggle:$(".toggle-users"),loginToggle:$(".toggle-login"),loginButton:$(".login-button"),chatInput:$(".chat-input")},panX:0,panY:0,scale:4,cooldown:0,init:function(){this.color=-1,this.connectionLost=!1,this.mod_tools_requested=!1,this.username=null,this.session_id=null,this.session_key=null,this.spectate_user=null,$(".board-container").hide(),$(".reticule").hide(),$(".ui").hide(),$(".message").hide(),$(".cursor").hide(),$(".cooldown-timer").hide(),this.elements.usersToggle.hide(),$.get("/boardinfo",this.initBoard.bind(this)),this.initBoardMovement(),this.initBoardPlacement(),this.initCursor(),this.initReticule(),this.initAlert(),this.initCoords(),this.initSidebar(),this.initMoveTicker()},initBoard:function(e){this.width=e.width,this.height=e.height,this.palette=e.palette,this.initPalette(),this.elements.board.attr("width",this.width).attr("height",this.height),this.updateTransform();var t=getQueryVariable("x")||this.width/2,s=getQueryVariable("y")||this.height/2;this.centerOn(t,s),this.scale=getQueryVariable("scale")||this.scale,this.updateTransform(),this.initSocket(),jQuery.get("/boarddata",this.drawBoard.bind(this))},drawBoard:function(e){for(var t=this.elements.board[0].getContext("2d"),s=new ImageData(this.width,this.height),i=new Uint32Array(s.data.buffer),n=this.width*this.height,o=this.palette.map(function(e){var t=hexToRgb(e);return 4278190080|t.b<<16|t.g<<8|t.r}),a=0;a<n;a++)i[a]=o[e.charCodeAt(a)];t.putImageData(s,0,0)},initPalette:function(){this.palette.forEach(function(e,t){$("<div>").addClass("palette-color").css("background-color",e).click(function(){0===this.cooldown?this.switchColor(t):this.switchColor(-1)}.bind(this)).appendTo(this.elements.palette)}.bind(this))},initBoardMovement:function(){var e=0,t=0,s=!1;$(document).on("keydown",function(e){"BODY"===e.target.nodeName&&(87===e.keyCode||38===e.keyCode?this.panY+=100/this.scale:83===e.keyCode||40===e.keyCode?this.panY-=100/this.scale:65===e.keyCode||37===e.keyCode?this.panX+=100/this.scale:68===e.keyCode||39===e.keyCode?this.panX-=100/this.scale:81===e.keyCode||34===e.keyCode?(this.scale/=1.3,this.scale=Math.min(40,Math.max(.7,this.scale))):69!==e.keyCode&&33!==e.keyCode||(this.scale*=1.3,this.scale=Math.min(40,Math.max(.7,this.scale))),this.updateTransform())}.bind(this)),this.elements.boardContainer.on("mousedown",function(i){this.spectate_user=null,this.alert(null),e=i.screenX,t=i.screenY,s=!0}.bind(this)).on("mousemove",function(i){if(s){var n=i.screenX-e,o=i.screenY-t;this.panX+=n/this.scale,this.panY+=o/this.scale,e=i.screenX,t=i.screenY,this.updateTransform()}}.bind(this)).on("mouseup",function(e){s=!1}.bind(this)).on("mouseout",function(e){s=!1}.bind(this)).on("wheel",function(e){var t=this.scale;e.originalEvent.deltaY>0?this.scale/=1.3:this.scale*=1.3,this.scale=Math.min(40,Math.max(.7,this.scale));var s=e.clientX-this.elements.boardContainer.width()/2,i=e.clientY-this.elements.boardContainer.height()/2;this.panX-=s/t,this.panX+=s/this.scale,this.panY-=i/t,this.panY+=i/this.scale,this.updateTransform()}.bind(this))},initBoardPlacement:function(){var e,t;this.elements.board.on("mousedown",function(s){e=s.clientX,t=s.clientY}).on("click",function(s){if(e===s.clientX&&t===s.clientY&&-1!==this.color&&0===this.cooldown){var i=this.screenToBoardSpace(s.clientX,s.clientY);this.place(i.x,i.y)}}.bind(this)).contextmenu(function(e){e.preventDefault(),this.switchColor(-1)}.bind(this))},initCursor:function(){$(document.body).on("mousemove",function(e){this.elements.cursor.css("transform","translate("+e.clientX+"px, "+e.clientY+"px)")}.bind(this))},initReticule:function(){this.elements.board.on("mousemove",function(e){var t=this.screenToBoardSpace(e.clientX,e.clientY);t.x|=0,t.y|=0;var s=this.boardToScreenSpace(t.x,t.y);this.elements.reticule.css("transform","translate("+s.x+"px, "+s.y+"px)"),this.elements.reticule.css("width",this.scale+"px").css("height",this.scale+"px"),-1===this.color?this.elements.reticule.hide():this.elements.reticule.show()}.bind(this))},initCoords:function(){this.elements.board.on("mousemove",function(e){var t=this.screenToBoardSpace(e.clientX,e.clientY);this.elements.coords.text("("+t.x+", "+t.y+")")}.bind(this))},initAlert:function(){this.elements.alert.find(".close").click(function(){this.elements.alert.fadeOut(200)}.bind(this))},forceSync:function(){jQuery.get("/boarddata",this.drawBoard.bind(this))},initSocket:function(){var e=window.location,t=("https:"===e.protocol?"wss://":"ws://")+e.host+"/ws",s=new WebSocket(t);this.socket=s,s.onopen=function(){$(".board-container").show(),$(".ui").show(),$(".loading").fadeOut(500),this.elements.alert.fadeOut(200),this.connectionLost&&(jQuery.get("/boarddata",this.drawBoard.bind(this)),null!=this.session_key&&s.send(JSON.stringify({type:"reauth",username:this.username,session_key:this.session_key})))}.bind(this),s.onmessage=function(e){var t=JSON.parse(e.data);if("session"===t.type){this.session_id=t.session_id,this.updateUserCount(t.users.length);var s=$(".user-list");s.empty(),t.users.forEach(function(e){$("<li>",{class:"username"}).text(e).appendTo(s)})}else if("pixel"===t.type){var i=this.elements.board[0].getContext("2d");i.fillStyle=this.palette[t.color],i.fillRect(t.x,t.y,1,1);var n=$(".move-ticker-body");if(n.is(":visible")){var o=$("<div>",{class:"chat-line"}).appendTo(n);$("<span>",{class:"username"}).text(t.session_id).appendTo(o),$("<span>").text(": ").appendTo(o),$("<a>",{href:"javascript:App.centerOn("+t.x+","+t.y+")"}).text(t.x+", "+t.y).appendTo(o),n.scrollTop(n.prop("scrollHeight")),n.children().length>=25&&n.find(".chat-line:first").remove()}null!==this.spectate_user&&this.spectate_user===t.session_id&&this.centerOn(t.x,t.y)}else if("alert"===t.type)this.alert(t.message);else if("cooldown"===t.type)this.cooldown=Math.ceil(t.wait)+1,this.updateTime();else if("chat"===t.type){var a=$(".chat-log"),o=$("<div>",{class:"chat-line"}).appendTo(a);$("<span>",{class:"username"}).text(t.chat_id).appendTo(o);var l,r=$("<span>",{class:"chat-message"}).text(": "+t.message),h=/([0-9]+)+\,(\ +)?([0-9]+)/g;do{if(l=h.exec(t.message)){var c=l[0].split(",");if(c[0]<0||c[0]>this.width||c[1]<0||c[1]>this.height)continue;var d=$("<a>",{class:"",href:"javascript:App.centerOn("+c[0]+","+c[1]+")"}).text(l[0]).prop("outerHTML");r.html(r.html().replace(l[0],d))}}while(l);r.appendTo(o),a.scrollTop(a.prop("scrollHeight")),a.children().length>=125&&a.find(".chat-line:first").remove()}else if("force-sync"===t.type)this.forceSync();else if("authenticate"===t.type)t.message&&this.alert(t.message),this.onAuthentication(t);else if("reauth"===t.type)t.success?(this.elements.loginToggle.text("Logout"),this.elements.loginButton.prop("disabled",!0)):(this.session_key=null,this.elements.loginToggle.text("Login"),this.elements.loginButton.prop("disabled",!1));else if("users"===t.type){this.updateUserCount(t.users.length);var s=$(".user-list");s.empty(),t.users.forEach(function(e){$("<li>",{class:"username"}).text(e).appendTo(s)})}}.bind(this),s.onclose=function(){this.connectionLost=!0,s.close(),this.alert("Disconnected from server... Attempting to reconnect"),setTimeout(this.initSocket.bind(this),1e3)}.bind(this)},updateUserCount:function(e){this.elements.usersToggle.fadeIn(200),this.elements.usersToggle.text("Users: "+e)},authenticateChat:function(){this.username=$("#username").val();var e=$("#password").val();this.socket.send(JSON.stringify({type:"auth",session_id:this.session_id,username:this.username,password:e}))},onAuthentication:function(data){data.success?(this.session_key=data.session_key,this.elements.loginToggle.text("Logout"),this.elements.loginContainer.hide(),this.elements.chatContainer.show(),data.is_moderator&&!this.mod_tools_requested&&(this.mod_tools_requested=!0,$.get("js/mod_tools.js",function(data){eval(data)})),this.elements.palette.addClass("palette-sidebar")):this.elements.loginButton.prop("disabled",!1)},initSidebar:function(){this.elements.chatToggle.click(function(){this.elements.chatContainer.toggle(),this.elements.usersContainer.hide(),this.elements.loginContainer.hide(),this.elements.chatContainer.is(":visible")?this.elements.palette.addClass("palette-sidebar"):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.usersToggle.click(function(){this.elements.chatContainer.hide(),this.elements.usersContainer.toggle(),this.elements.loginContainer.hide(),this.elements.usersContainer.is(":visible")?this.elements.palette.addClass("palette-sidebar"):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.loginToggle.click(function(){if(null!=this.session_key)return this.elements.loginToggle.text("Login"),this.socket.send(JSON.stringify({type:"logout",session_id:this.session_id,session_key:this.session_key})),this.session_key=null,void this.elements.loginButton.prop("disabled",!1);this.elements.chatContainer.hide(),this.elements.usersContainer.hide(),this.elements.loginContainer.toggle(),this.elements.loginContainer.is(":visible")?this.elements.palette.addClass("palette-sidebar"):this.elements.palette.removeClass("palette-sidebar")}.bind(this)),this.elements.loginButton.click(function(){this.elements.loginButton.prop("disabled",!0),this.authenticateChat()}.bind(this)),this.elements.chatInput.keypress(function(e){if(13==e.which){e.preventDefault();var t=this.elements.chatInput.val();if(""===t)return;this.socket.send(JSON.stringify({session_id:this.session_id,type:"chat",message:t})),this.elements.chatInput.val("")}}.bind(this))},initMoveTicker:function(){var e=$(".user-list"),t=$(".move-ticker-header"),s=$(".move-ticker-body");t.click(function(){s.toggle(),s.scrollTop(s.prop("scrollHeight")),s.is(":visible")?e.addClass("user-list-ticker"):e.removeClass("user-list-ticker")})},updateTransform:function(){this.elements.boardMover.css("width",this.width+"px").css("height",this.height+"px").css("transform","translate("+this.panX+"px, "+this.panY+"px)"),this.elements.boardZoomer.css("transform","scale("+this.scale+")")},screenToBoardSpace:function(e,t){var s=this.elements.board[0].getBoundingClientRect();return{x:(e-s.left)/this.scale|0,y:(t-s.top)/this.scale|0}},boardToScreenSpace:function(e,t){var s=this.elements.board[0].getBoundingClientRect();return{x:e*this.scale+s.left,y:t*this.scale+s.top}},centerOn:function(e,t){this.panX=500-e-.5,this.panY=500-t-.5,this.updateTransform()},switchColor:function(e){this.color=e,-1===e?this.elements.cursor.hide():(this.elements.cursor.show(),this.elements.cursor.css("background-color",this.palette[e]))},place:function(e,t){-1!==this.color&&this.socket.send(JSON.stringify({type:"place",session_id:this.session_id,x:e,y:t,color:this.color}))},alert:function(e){var t=this.elements.alert;if(null===e)return void this.elements.alert.fadeOut(200);t.find(".text").text(e),t.fadeIn(200)},updateTime:function(){var e=this.cooldown;if(this.cooldown-=1,this.cooldown<0&&(this.cooldown=0),this.cooldown|=0,0!==this.cooldown){this.elements.timer.show();var t=Math.floor(this.cooldown%60),s=t<10?"0"+t:t,i=Math.floor(this.cooldown/60),n=i<10?"0"+i:i;this.elements.timer.text(n+":"+s),$(".palette-color").css("cursor","not-allowed")}else this.elements.timer.hide(),$(".palette-color").css("cursor","");0===this.cooldown&&0!==e||setTimeout(this.updateTime.bind(this),1e3)},spectate:function(e){this.alert("Spectating "+e),this.spectate_user=e}},$.contextMenu({selector:".username",trigger:"right",zIndex:1e3,items:{spectate:{name:"Spectate",callback:function(e,t){App.spectate(t.$trigger.text())}}}}),App.init();