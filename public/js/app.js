function getQueryVariable(t){for(var e=window.location.search.substring(1),s=e.split("&"),i=0;i<s.length;i++){var n=s[i].split("=");if(decodeURIComponent(n[0])===t)return decodeURIComponent(n[1])}}function hexToRgb(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}window.App={elements:{board:$("#board"),palette:$(".palette"),boardMover:$(".board-mover"),boardZoomer:$(".board-zoomer"),boardContainer:$(".board-container"),cursor:$(".cursor"),timer:$(".cooldown-timer"),reticule:$(".reticule"),alert:$(".message"),coords:$(".coords"),userCount:$(".user-count"),chatToggle:$(".chat-tab"),chatContainer:$(".chat"),chatInput:$(".chat-input")},panX:0,panY:0,scale:4,cooldown:0,init:function(){this.color=-1,this.connectionLost=!1,this.username=null,this.session_id=null,this.session_key=null,this.spectate_user=null,$(".board-container").hide(),$(".reticule").hide(),$(".ui").hide(),$(".message").hide(),$(".cursor").hide(),$(".cooldown-timer").hide(),this.elements.userCount.hide(),$.get("/boardinfo",this.initBoard.bind(this)),this.initBoardMovement(),this.initBoardPlacement(),this.initCursor(),this.initReticule(),this.initAlert(),this.initCoords(),this.initChat(),this.initMoveTicker()},initBoard:function(t){this.width=t.width,this.height=t.height,this.palette=t.palette,this.initPalette(),this.elements.board.attr("width",this.width).attr("height",this.height),this.updateTransform();var e=getQueryVariable("x")||this.width/2,s=getQueryVariable("y")||this.height/2;this.centerOn(e,s),this.scale=getQueryVariable("scale")||this.scale,this.updateTransform(),this.initSocket(),jQuery.get("/boarddata",this.drawBoard.bind(this))},drawBoard:function(t){for(var e=this.elements.board[0].getContext("2d"),s=new ImageData(this.width,this.height),i=new Uint32Array(s.data.buffer),n=this.width*this.height,o=this.palette.map(function(t){var e=hexToRgb(t);return 4278190080|e.b<<16|e.g<<8|e.r}),a=0;a<n;a++)i[a]=o[t.charCodeAt(a)];e.putImageData(s,0,0)},initPalette:function(){this.palette.forEach(function(t,e){$("<div>").addClass("palette-color").css("background-color",t).click(function(){0===this.cooldown?this.switchColor(e):this.switchColor(-1)}.bind(this)).appendTo(this.elements.palette)}.bind(this))},initBoardMovement:function(){var t=0,e=0,s=!1;this.elements.boardContainer.on("mousedown",function(i){this.spectate_user=null,this.alert(null),t=i.screenX,e=i.screenY,s=!0}.bind(this)).on("mousemove",function(i){if(s){var n=i.screenX-t,o=i.screenY-e;this.panX+=n/this.scale,this.panY+=o/this.scale,t=i.screenX,e=i.screenY,this.updateTransform()}}.bind(this)).on("mouseup",function(t){s=!1}.bind(this)).on("mouseout",function(t){s=!1}.bind(this)).on("wheel",function(t){var e=this.scale;t.originalEvent.deltaY>0?this.scale/=1.3:this.scale*=1.3,this.scale=Math.min(40,Math.max(.7,this.scale));var s=t.clientX-this.elements.boardContainer.width()/2,i=t.clientY-this.elements.boardContainer.height()/2;this.panX-=s/e,this.panX+=s/this.scale,this.panY-=i/e,this.panY+=i/this.scale,this.updateTransform()}.bind(this))},initBoardPlacement:function(){var t,e;this.elements.board.on("mousedown",function(s){t=s.clientX,e=s.clientY}).on("click",function(s){if(t===s.clientX&&e===s.clientY&&-1!==this.color&&0===this.cooldown){var i=this.screenToBoardSpace(s.clientX,s.clientY);this.place(i.x,i.y)}}.bind(this)).contextmenu(function(t){t.preventDefault(),this.switchColor(-1)}.bind(this))},initCursor:function(){$(document.body).on("mousemove",function(t){this.elements.cursor.css("transform","translate("+t.clientX+"px, "+t.clientY+"px)")}.bind(this))},initReticule:function(){this.elements.board.on("mousemove",function(t){var e=this.screenToBoardSpace(t.clientX,t.clientY);e.x|=0,e.y|=0;var s=this.boardToScreenSpace(e.x,e.y);this.elements.reticule.css("transform","translate("+s.x+"px, "+s.y+"px)"),this.elements.reticule.css("width",this.scale+"px").css("height",this.scale+"px"),-1===this.color?this.elements.reticule.hide():this.elements.reticule.show()}.bind(this))},initCoords:function(){this.elements.board.on("mousemove",function(t){var e=this.screenToBoardSpace(t.clientX,t.clientY);this.elements.coords.text("("+e.x+", "+e.y+")")}.bind(this))},initAlert:function(){this.elements.alert.find(".close").click(function(){this.elements.alert.fadeOut(200)}.bind(this))},forceSync:function(){jQuery.get("/boarddata",this.drawBoard.bind(this))},initSocket:function(){var t=window.location,e=("https:"===t.protocol?"wss://":"ws://")+t.host+t.pathname+"ws",s=new WebSocket(e);this.socket=s,s.onopen=function(){$(".board-container").show(),$(".ui").show(),$(".loading").fadeOut(500),this.elements.alert.fadeOut(200),this.connectionLost&&(jQuery.get("/boarddata",this.drawBoard.bind(this)),null!=this.session_key&&s.send(JSON.stringify({type:"reauth",username:this.username,session_key:this.session_key})))}.bind(this),s.onmessage=function(t){var e=JSON.parse(t.data);if("session"===e.type){this.session_id=e.session_id,this.updateUserCount(e.users.length);var s=$(".user-list");s.empty(),e.users.forEach(function(t){$("<li>",{class:"username"}).text(t).appendTo(s)})}else if("pixel"===e.type){var i=this.elements.board[0].getContext("2d");i.fillStyle=this.palette[e.color],i.fillRect(e.x,e.y,1,1);var n=$(".move-ticker-body");if(n.is(":visible")){var o=$("<div>",{class:"chat-line"}).appendTo(n);$("<span>",{class:"chat-id"}).text(e.session_id+": ").appendTo(o),$("<span>",{class:"chat-message"}).text("x: "+e.x+" y: "+e.y).appendTo(o),n.scrollTop(n.prop("scrollHeight")),n.children().length>=25&&n.find(".chat-line:first").remove()}null!==this.spectate_user&&this.spectate_user===e.session_id&&this.centerOn(e.x,e.y)}else if("alert"===e.type)this.alert(e.message);else if("cooldown"===e.type)this.cooldown=Math.ceil(e.wait)+1,this.updateTime();else if("chat"===e.type){var a=$(".chat-log"),o=$("<div>",{class:"chat-line"}).appendTo(a);$("<span>",{class:"chat-id"}).text(e.chat_id+": ").appendTo(o),$("<span>",{class:"chat-message"}).text(e.message).appendTo(o),a.scrollTop(a.prop("scrollHeight")),a.children().length>=125&&a.find(".chat-line:first").remove()}else if("force-sync"===e.type)this.forceSync();else if("authenticate"===e.type)e.message&&this.alert(e.message),this.onAuthentication(e);else if("reauth"===e.type){var r=$(".chat-login"),h=$(".login-button");e.success?(r.text("Logout"),h.prop("disabled",!0)):(r.text("Login"),this.session_key=null,h.prop("disabled",!1))}else if("users"===e.type){this.updateUserCount(e.users.length);var s=$(".user-list");s.empty(),e.users.forEach(function(t){$("<li>",{class:"username"}).text(t).appendTo(s)})}}.bind(this),s.onclose=function(){this.connectionLost=!0,s.close(),this.alert("Disconnected from server... Attempting to reconnect"),setTimeout(this.initSocket.bind(this),1e3)}.bind(this)},updateUserCount:function(t){this.elements.userCount.fadeIn(200),this.elements.userCount.text("Users: "+t)},authenticateChat:function(){this.username=$("#username").val();var t=$("#password").val();this.socket.send(JSON.stringify({type:"auth",session_id:this.session_id,username:this.username,password:t}))},onAuthentication:function(data){var loginContainer=$(".login-container"),loginToggle=$(".chat-login"),chatBody=$(".chat-body"),loginButton=$(".login-button");data.success?(this.session_key=data.session_key,loginToggle.text("Logout"),loginContainer.hide(),chatBody.show(),data.is_moderator&&$.get("js/mod_tools.js",function(data){eval(data)}),this.elements.palette.addClass("palette-chat")):loginButton.prop("disabled",!1)},initChat:function(){var t=$(".chat-toggle"),e=$(".user-count"),s=$(".chat-login"),i=$(".login-button"),n=$(".chat-body"),o=$(".chat-input"),a=$(".users-container"),r=$(".login-container");t.click(function(){n.toggle(),a.hide(),r.hide(),n.is(":visible")?this.elements.palette.addClass("palette-chat"):this.elements.palette.removeClass("palette-chat")}.bind(this)),i.click(function(){i.prop("disabled",!0),this.authenticateChat()}.bind(this)),s.click(function(){if(null!=this.session_key)return s.text("Login"),this.socket.send(JSON.stringify({type:"logout",session_id:this.session_id,session_key:this.session_key})),this.session_key=null,void i.prop("disabled",!1);n.hide(),a.hide(),r.toggle(),r.is(":visible")?this.elements.palette.addClass("palette-chat"):this.elements.palette.removeClass("palette-chat")}.bind(this)),e.click(function(){n.hide(),a.toggle(),r.hide(),a.is(":visible")?this.elements.palette.addClass("palette-chat"):this.elements.palette.removeClass("palette-chat")}.bind(this)),o.keypress(function(t){if(13==t.which){t.preventDefault();var e=o.val();if(""===e)return;this.socket.send(JSON.stringify({session_id:this.session_id,type:"chat",message:e})),o.val("")}}.bind(this))},initMoveTicker:function(){var t=$(".move-ticker-header"),e=$(".move-ticker-body"),s=$(".user-list");t.click(function(){e.toggle(),e.scrollTop(e.prop("scrollHeight")),e.is(":visible")?s.addClass("user-list-ticker"):s.removeClass("user-list-ticker")})},updateTransform:function(){this.elements.boardMover.css("width",this.width+"px").css("height",this.height+"px").css("transform","translate("+this.panX+"px, "+this.panY+"px)"),this.elements.boardZoomer.css("transform","scale("+this.scale+")")},screenToBoardSpace:function(t,e){var s=this.elements.board[0].getBoundingClientRect();return{x:(t-s.left)/this.scale|0,y:(e-s.top)/this.scale|0}},boardToScreenSpace:function(t,e){var s=this.elements.board[0].getBoundingClientRect();return{x:t*this.scale+s.left,y:e*this.scale+s.top}},centerOn:function(t,e){this.panX=500-t-.5,this.panY=500-e-.5,this.updateTransform()},switchColor:function(t){this.color=t,-1===t?this.elements.cursor.hide():(this.elements.cursor.show(),this.elements.cursor.css("background-color",this.palette[t]))},place:function(t,e){this.socket.send(JSON.stringify({type:"place",session_id:this.session_id,x:t,y:e,color:this.color}))},alert:function(t){var e=this.elements.alert;if(null===t)return void this.elements.alert.fadeOut(200);e.find(".text").text(t),e.fadeIn(200)},updateTime:function(){var t=this.cooldown;if(this.cooldown-=1,this.cooldown<0&&(this.cooldown=0),this.cooldown|=0,0!==this.cooldown){this.elements.timer.show();var e=Math.floor(this.cooldown%60),s=e<10?"0"+e:e,i=Math.floor(this.cooldown/60),n=i<10?"0"+i:i;this.elements.timer.text(n+":"+s),$(".palette-color").css("cursor","not-allowed")}else this.elements.timer.hide(),$(".palette-color").css("cursor","");0===this.cooldown&&0!==t||setTimeout(this.updateTime.bind(this),1e3)},spectate:function(t){this.alert("Spectating "+t),this.spectate_user=t}},$.contextMenu({selector:".username",trigger:"right",zIndex:1e3,items:{spectate:{name:"Spectate",callback:function(t,e){App.spectate(e.$trigger.text())}}}}),App.init();